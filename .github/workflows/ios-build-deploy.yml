name: iOS Build and Deploy

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub repository URL'
        required: true
        type: string
        default: 'https://github.com/bariamanoj/manzzfinaltest.git'
      app_name:
        description: 'App name'
        required: true
        type: string
        default: 'Manzzfinal test1'
      bundle_identifier:
        description: 'Bundle identifier'
        required: true
        type: string
        default: 'com.manzz.finaltest1'
      contact_first_name:
        description: 'Contact first name'
        required: true
        type: string
        default: 'SANKETKUMAR'
      contact_last_name:
        description: 'Contact last name'
        required: true
        type: string
        default: 'DOHRA'
      contact_phone:
        description: 'Contact phone'
        required: true
        type: string
        default: '+91 9265171259'
      contact_email:
        description: 'Contact email'
        required: true
        type: string
        default: 'dohrasanket@gmail.com'
      app_description:
        description: 'App description'
        required: true
        type: string
        default: 'This manzzfinaltest app is just simple, sample demo app where you can get lots of details and guide and tips, This app spedically design for you, so why are you waiting just download and enjoy it.'
      marketing_url:
        description: 'Marketing URL'
        required: true
        type: string
        default: 'https://dohrasanket.pages.dev/'
      privacy_policy_url:
        description: 'Privacy policy URL'
        required: true
        type: string
        default: 'https://dohrasanket.pages.dev/PrivacyPolicy'
      support_url:
        description: 'Support URL'
        required: true
        type: string
        default: 'https://dohrasanket.pages.dev/support'

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: bariamanoj/manzzfinaltest
        token: ${{ secrets.GH_TOKEN }}
        path: target-repo
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: true
    
    - name: Install Fastlane
      run: gem install fastlane
    
    - name: Create Fastfile
      run: |
        cd target-repo
        mkdir -p fastlane
        # Copy the Fastfile from the workflow repo
        curl -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
             -H "Accept: application/vnd.github.v3.raw" \
             -o fastlane/Fastfile \
             https://api.github.com/repos/bariamanoj/manzzworkflow/contents/Fastfile

    - name: Create metadata structure
      run: |
        cd target-repo
        mkdir -p fastlane/metadata/en-US
        echo "${{ github.event.inputs.app_name }}" > fastlane/metadata/en-US/name.txt
        echo "${{ github.event.inputs.app_description }}" > fastlane/metadata/en-US/description.txt
        echo "${{ github.event.inputs.marketing_url }}" > fastlane/metadata/en-US/marketing_url.txt
        echo "${{ github.event.inputs.privacy_policy_url }}" > fastlane/metadata/en-US/privacy_url.txt
        echo "${{ github.event.inputs.support_url }}" > fastlane/metadata/en-US/support_url.txt
        echo "@Manzzfinal 2025" > fastlane/metadata/en-US/copyright.txt
        echo "UTILITIES" > fastlane/metadata/en-US/primary_category.txt
        echo "Manzzfinal test1" > fastlane/metadata/en-US/keywords.txt
        
        # Review information
        mkdir -p fastlane/metadata/review_information
        echo "${{ github.event.inputs.contact_first_name }}" > fastlane/metadata/review_information/first_name.txt
        echo "${{ github.event.inputs.contact_last_name }}" > fastlane/metadata/review_information/last_name.txt
        echo "${{ github.event.inputs.contact_phone }}" > fastlane/metadata/review_information/phone_number.txt
        echo "${{ github.event.inputs.contact_email }}" > fastlane/metadata/review_information/email_address.txt
        echo "Test app for ManzTestApp2025" > fastlane/metadata/review_information/notes.txt

    - name: Run Fastlane deployment
      continue-on-error: true
      working-directory: target-repo
      env:
        APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
        APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
        FASTLANE_SESSION_SECRET: ${{ secrets.FASTLANE_SESSION }}
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD_SECRET: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        APP_NAME: ${{ github.event.inputs.app_name }}
        BUNDLE_IDENTIFIER: ${{ github.event.inputs.bundle_identifier }}
        FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 120
        FASTLANE_XCODE_LIST_TIMEOUT: 120
      run: fastlane deploy

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-artifacts
        path: target-repo/build/
        retention-days: 7
